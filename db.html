<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<title>Deploy</title>
<link rel="api" href="http://api.laisiangtho.com/"/>
<link rel="icon" href="img/icon.16.png" type="image/png"/>
<script src="js/jquery.js"></script>
<script src="js/jquery.ui.js"></script>
<script src="js/jquery.mobile.js"></script>
<script src="js/data.bible.js"type="text/javascript"></script>
<script src="js/data.config.js"type="text/javascript"></script>

<script src="js/localforage.min.js"></script>
<script>
localforage.config({
    driver: [localforage.INDEXEDDB,localforage.WEBSQL,localforage.LOCALSTORAGE],
    name:config.store.name,
	storeName:'store',
	version:config.store.version,
	description:'the Holy Bible'
});
/*
localforage.ready(function() {
	console.log('ready', arguments);
	
	localforage.setItem('testKey', 'testValue').then(
		function(){
			console.log('setItem 1: ', arguments);
		},
		function(){
			console.log('setItem: ', arguments);
		}
	);
	
	localforage.getItem('testKey').then(
		function(){
			console.log('getItem 1: ', arguments);
		},
		function(){
			console.log('getItem: ', arguments);
		}
	);
	
	}).then(
	function() {
	
	}, 
	function() {
		console.log('ready().then', arguments);
		console.log('localforage.driver():', localforage.driver());
	
		localforage.setDriver([localforage.WEBSQL,localforage.INDEXEDDB,localforage.LOCALSTORAGE]).then(
			function(){
				console.log('setDriver 1', arguments);
			},
			function(){
				console.log('setDriver', arguments);
			}
		);
});
*/
/*
localforage.setDriver([localforage.INDEXEDDB,localforage.WEBSQL,localforage.LOCALSTORAGE]).then(function() {
	console.log('Done');
});
*/
//localforage.clear();
/*
localforage.ready(function() {
	localforage.getItem(config.store.info, function(err, storeInfo) {
		localforage.getItem(config.store.user.bible, function(err, storeUserBible) {
			if(storeUserBible){
				if(storeInfo){
					lai.user.bible=storeUserBible; process_query();
					//console.log(1);
				}else{
					lai.user.bible=load.available(storeUserBible);
					sql.user.bible.delete().onsuccess=sql.user.bible.add().onsuccess=process_query();
					//console.log(2);
				}
			}else{
				lai.user.bible=load.available();
				sql.user.bible.add().onsuccess=process_query();
				//console.log(3);
			}
		});
	});
	//localforage.getItem(config.store.info, function(err, storeInfo) {});
});
*/

	var db={
		init:function(callback){
			var o=this;
			localforage.config({driver:[localforage.INDEXEDDB,localforage.WEBSQL,localforage.LOCALSTORAGE],name:config.store.name,storeName:'store',version:config.store.version,description:'the Holy Bible'});
			this.driver().then(function(){
				delete o.init; delete o.driver;
			});
			this.ready().then(function(){
				delete o.ready; callback(o);
			});
		},
		driver:function(){
			return localforage.setDriver([localforage.INDEXEDDB,localforage.WEBSQL,localforage.LOCALSTORAGE]);//.then(function() {});
		},
		ready:function(){
			return localforage.ready();
		},
		deleteDatabase:function(){
			return localforage.clear();
		},
		add:function(q){
			return localforage.setItem(q.table, q.data);
		},
		get:function(q){
			return localforage.getItem(q.table);
		},
		put:function(q){
			return localforage.setItem(q.table, q.data);
		},
		read:function(q){
			localforage.keys(q);
		},
		delete:function(q){
			return localforage.removeItem(q.table);
		}
	};
	db.init(function(sql) {
		//console.log('ready',sql);
		/*
		sql.add({table:config.store.info,data:{a:1,b:2}}).then(function(val){
			console.log(val);
		});
		sql.get({table:config.store.info}).then(function(storeInfo){
		});
		*/
		sql.get({table:config.store.info}).then(function(storeInfo){
			sql.get({table:config.store.user.bible}).then(function(storeUserBible){
				if(storeUserBible){
					if(storeInfo){
						lai.user.bible=storeInfo; process_query();
						//console.log(1);
					}else{
						lai.user.bible=load.available(storeUserBible);
						sql.put({table:config.store.user.bible,data:lai.user.bible}).then(process_query());
						//console.log(2);
					}
				}else{
					lai.user.bible=load.available();
					sql.add({table:config.store.user.bible,data:lai.user.bible}).then(process_query());
					//console.log(3);
				}
			});
			function process_query(){
				sql.get({table:config.store.user.query}).then(function(storeQuery){
					if(storeQuery){
						lai.user.query=storeQuery; process_trigger();
					}else{
						sql.add({table:config.store.user.query,data:lai.user.query}).then(process_trigger());
					}
				});
			};
			function process_trigger(){
				config.bible.available=Object.keys(lai.user.bible);
				l7=config.bible.available.concat();
				if(storeInfo){
					sql.build=storeInfo; load.go();
				}else{
					sql.add({table:config.store.info,data:{build:config.build,version:config.version}}).then(load.go());
				}
			};
		});
	});

/*
if(this.db().init(config.local)){
	this.db.load(function(sql){
		sql.info.get().onsuccess=function(i){
			//console.log('--',i.target.result);
			sql.user.bible.get().onsuccess=function(b){
				if(b.target.result){
					if(i.target.result){
						lai.user.bible=b.target.result.bible; process_query();
						//console.log(1);
					}else{
						lai.user.bible=load.available(b.target.result.bible);
						sql.user.bible.delete().onsuccess=sql.user.bible.add().onsuccess=process_query();
						//console.log(2);
					}
				}else{
					lai.user.bible=load.available();
					sql.user.bible.add().onsuccess=process_query();
					//console.log(3);
				}
			};
			function process_query(){
				sql.user.query.get().onsuccess=function(q){
					if(q.target.result){
						lai.user.query=q.target.result.query; process_trigger();
					}else{
						sql.user.query.add().onsuccess=process_trigger();
					}
				}
			};
			function process_trigger(){
				config.bible.available=Object.keys(lai.user.bible);
				l7=config.bible.available.concat();
				if(i.target.result){
					sql.build=i.target.result; load.go();
				}else{
					sql.info.clear().onsuccess=sql.info.add().onsuccess=load.go();
				}
			};
		};
		sql.user.lookup.get().onsuccess=function(e){
			if(e.target.result){
				//console.log(e.target.result);
				lai.user.lookup=e.target.result;
			}else{
				sql.user.lookup.add();
			}
		};
		sql.user.note.get().onsuccess=function(e){
			if(e.target.result){
				//console.log(e.target.result);
				lai.user.note=e.target.result;
			}else{
				sql.user.note.add();
			}
		}
	});
}else{
	l7=config.bible.available.concat();
	load.get();
}
localforage.ready(function() {
	console.log('Ready');
	var key = 'STORE_KEY';
	// var value = 'What we save offline';
	var value = new Uint8Array(8);
	value[0] = 65
	// var value = undefined;
	var UNKNOWN_KEY = 'unknown_key';
	
	localforage.setItem(key, value, function() {
		console.log('Saved: ' + value);
		
		localforage.getItem(key, function(err, readValue) {
			console.log('Read: ', readValue);
		});
		
		// Since this key hasn't been set yet, we'll get a null value
		localforage.getItem(UNKNOWN_KEY, function(err, readValue) {
			console.log('Result of reading ' + UNKNOWN_KEY, readValue);
		});
	});
});
*/
/*
localforage.setDriver([localforage.INDEXEDDB, localforage.WEBSQL, localforage.LOCALSTORAGE]).then(function() {
	var key = 'STORE_KEY';
	// var value = 'What we save offline';
	var value = new Uint8Array(8);
	value[0] = 65
	// var value = undefined;
	var UNKNOWN_KEY = 'unknown_key';
	
	localforage.setItem(key, value, function() {
		console.log('Saved: ' + value);
		
		localforage.getItem(key, function(err, readValue) {
			console.log('Read: ', readValue);
		});
		
		// Since this key hasn't been set yet, we'll get a null value
		localforage.getItem(UNKNOWN_KEY, function(err, readValue) {
			console.log('Result of reading ' + UNKNOWN_KEY, readValue);
		});
	});
});
*/

/*

// Forcing localstorage here. Feel free to switch to other drivers :)
localforage.setDriver([localforage.INDEXEDDB, localforage.WEBSQL, localforage.LOCALSTORAGE]).then(function() {
	var key = 'STORE_KEY';
	// var value = 'What we save offline';
	var value = new Uint8Array(8);
	value[0] = 65
	// var value = undefined;
	var UNKNOWN_KEY = 'unknown_key';
	
	localforage.setItem(key, value, function() {
		console.log('Saved: ' + value);
		
		localforage.getItem(key, function(err, readValue) {
		console.log('Read: ', readValue);
		});
		
		// Since this key hasn't been set yet, we'll get a null value
		localforage.getItem(UNKNOWN_KEY, function(err, readValue) {
		console.log('Result of reading ' + UNKNOWN_KEY, readValue);
		});
	});
});
*/
</script>
</head>
<body id="l189">
Deploy
</body>
</html>